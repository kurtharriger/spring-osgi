  <chapter id="bundles">
    <title>Working with Bundles</title>

    <para>Spring-DM offers a dedicated schema element for interacting with existing
    bundles or for installing new ones. While it is not intended to be used as a replacement
    for proper OSGi services, the <literal>bundle</literal> element offers a very
    easy way of executing actions on bundles based on the lifecycle of the application
    context. 
    </para>
        
    <para>The <literal>bundle</literal> element defines a bean of type
    <interfacename>org.osgi.framework.Bundle</interfacename>. It provides a simple way to
    work directly with bundles, including driving their lifecycle. In the
    simplest case all you need to do is specify the
    <literal>symbolic-name</literal> of the bundle you are interested
    in:</para>

    <programlisting><![CDATA[<bundle id="aBundle" symbolic-name="org.xyz.abundle"/>]]></programlisting>

    <para>The bean <literal>aBundle</literal> can now be injected into any property of 
    type <interfacename>Bundle</interfacename>.</para>

    <para>If the needed bundle is not installed, one can use <literal>location</literal> attribute
    to indicate install or/and the <literal>action</literal>/<literal>dispose-action</literal> attributes
    provide declarative control over the bundle's lifecycle. The <literal>location</literal> attribute is 
    used to specify a URL where the bundle jar file artifact can be found. The
    <literal>action</literal> attribute specifies the lifecycle operation to
    be invoked on the bundle object. The supported action values are
    <literal>install</literal>, <literal>start</literal>,
    <literal>update</literal>, <literal>stop</literal>, and
    <literal>uninstall</literal>. These actions have the same semantics as the
    operations of the corresponding names defined on the
    <literal>Bundle</literal> interface (see the OSGi Service Platform Core
    Specification), with the exception that pre-conditions are weakened to
    allow for example a <emphasis>start</emphasis> action to be specified against a bundle that
    is not currently installed (it will be installed first).</para>
    
    <para>The following table shows how actions are interpreted for the given
    Bundle states:</para>

    <table id ="bundle-factory-actions" border="1" cellspacing="5" pgwide="1">
      <title><![CDATA[<bundle>]]> <literal>action</literal> values</title>
     	<tgroup cols="3">
         <colspec align="center" />
         <thead>
          <row>
           <entry>Action</entry>
           <entry>UNINSTALLED</entry>
           <entry>INSTALLED/RESOLVED</entry>
           <entry>ACTIVE</entry>
         </row>
        </thead>
        <tbody>
         <row>
            <entry>START</entry>
            <entry>installs and starts the bundle</entry>
	        <entry>starts the bundle</entry>
	        <entry>no action taken, bundle already started</entry>
    	</row>

    	<row>
	        <entry>UPDATE</entry>
	        <entry>installs the bundle and then updates it (`Bundle.update()`)</entry>
	        <entry>updates the bundle</entry>
	        <entry>updates the bundle</entry>
       </row>

       <row>
          <entry>STOP</entry>
	      <entry>no action taken</entry>
	      <entry>no action taken</entry>
	      <entry>bundle is stopped</entry>
      </row>

      <row>
        <entry>UNINSTALL</entry>
        <entry>no action taken</entry>
        <entry>bundle is uninstalled</entry>
        <entry>bundle is stopped and then uninstalled</entry>
      </row>
     </tbody>
     </tgroup>      
    </table>

    <para>For example:</para>

    <programlisting><![CDATA[<!-- ensure this bundle is installed and started -->;
<bundle id="aBundle" symbolic-name="org.xyz.abundle"
   location="http://www.xyz.com/bundles/org.xyz.abundle.jar"
   action="start"/>]]></programlisting>

    <!-- 
    <para>The 'start-level' attribute can be used to set the start level of
    the bundle.</para>
    -->
    
    <para>The following table lists the <literal>bundle</literal> element attributes names, 
    possible values and a short description for each of them.
    </para>
   	
   	<table id="bundle-options" pgwide="1">
      <title><![CDATA[<bundle> attributes]]></title>
       <tgroup cols="3">
         <colspec align="center" />
         <thead>
           <row>
             <entry>Name</entry>
             <entry>Values</entry>
             <entry>Description</entry>
           </row>
         </thead>
         <tbody>
           <row>
             <entry>symbolic-name</entry>
             <entry>any valid symbolic-name String</entry>
             <entry>The bundle symbolic name of the bundle object. Normally used when interacting with an already 
             installed bundle.</entry>
           </row>
           <row>
             <entry>location</entry>
             <entry>String that can be converted into an <literal>URL</literal></entry>
             <entry>Location used to install, update or/and identify a bundle.</entry>
           </row>
           <row>
             <entry>action</entry>
             <entry>start | stop | install | uninstall | update</entry>
             <entry>Lifecyle action to drive on the bundle. The action is executed at startup.</entry>
           </row>
           <row>
             <entry>destroy-action</entry>
             <entry>(same as action)</entry>
             <entry>Lifecyle action to drive on the bundle. The action is executed at shutdown.</entry>
           </row>
         </tbody>
       </tgroup>
    </table>

    <para>The samples that ship with the Spring Dynamic Modules project
    include further support for a <literal>virtual-bundle</literal> element
    that can be used to create and install OSGi bundles on the fly from
    existing artifacts.</para>
  </chapter>
